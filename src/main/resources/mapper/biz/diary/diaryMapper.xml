<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="heyso.HeysoDiaryBackEnd.diary.mapper.DiaryMapper">

    <resultMap id="DiarySummaryResultMap" type="heyso.HeysoDiaryBackEnd.diary.model.DiarySummary">
        <id column="diary_id" property="diaryId"/>
        <result column="user_id" property="authorId"/>
        <result column="author_nickname" property="authorNickname"/>
        <result column="title" property="title"/>
        <result column="content_md" property="contentMd"/>
        <result column="diary_date" jdbcType="DATE" property="diaryDate"/>
        <result column="created_at" jdbcType="TIMESTAMP" property="createdAt"/>
        <result column="updated_at" jdbcType="TIMESTAMP" property="updatedAt"/>
    </resultMap>

    <select id="selectDiaryList" resultMap="DiarySummaryResultMap">
        SELECT
            d.diary_id,
            d.user_id,
            u.nickname AS author_nickname,
            d.title,
            d.content_md,
            d.diary_date,
            d.created_at,
            d.updated_at
        FROM tb_diary d
        INNER JOIN tb_user u ON u.user_id = d.user_id
        WHERE d.is_deleted = 0
            AND d.user_id = #{request.userId}
        ORDER BY d.diary_date DESC, d.created_at DESC
        LIMIT #{request.offset}, #{request.size}
    </select>

    <select id="selectDailyDiaryList" resultMap="DiarySummaryResultMap">
        SELECT
            d.diary_id,
            d.user_id,
            u.nickname AS author_nickname,
            d.title,
            d.content_md,
            d.diary_date,
            d.created_at,
            d.updated_at
        FROM tb_diary d
        INNER JOIN tb_user u ON u.user_id = d.user_id
        WHERE d.is_deleted = 0
            AND d.user_id = #{userId}
            AND d.diary_date = #{diaryDate}
        ORDER BY d.created_at DESC
    </select>

    <select id="selectDiaryMonthlyCounts" resultType="heyso.HeysoDiaryBackEnd.diary.model.DiaryMonthlyCount">
        SELECT
            td.diary_date,
            COUNT(*) AS diary_count
        FROM tb_diary td
        WHERE td.user_id = #{userId}
          AND td.diary_date LIKE CONCAT(#{diaryMonth}, '%')
          AND td.is_deleted = 0
        GROUP BY td.diary_date
        ORDER BY td.diary_date
    </select>

    <select id="selectDiaryById" resultMap="DiarySummaryResultMap">
        SELECT
            d.diary_id,
            d.user_id,
            u.nickname AS author_nickname,
            d.title,
            d.content_md,
            d.diary_date,
            d.created_at,
            d.updated_at
        FROM tb_diary d
        INNER JOIN tb_user u ON u.user_id = d.user_id
        WHERE d.diary_id = #{diaryId}
          AND d.is_deleted = 0
    </select>

    <insert id="insertDiary" parameterType="heyso.HeysoDiaryBackEnd.diary.model.Diary"
            useGeneratedKeys="true" keyProperty="diaryId">
        INSERT INTO tb_diary (
            user_id,
            title,
            content_md,
            diary_date,
            is_deleted,
            created_at,
            updated_at
        )
        VALUES (
            #{userId},
            #{title},
            #{contentMd},
            #{diaryDate},
            0,
            NOW(),
            NOW()
        )
    </insert>

    <update id="updateDiary">
        UPDATE tb_diary
        SET
            title = #{title},
            content_md = #{contentMd},
            diary_date = #{diaryDate},
            updated_at = NOW()
        WHERE diary_id = #{diaryId}
          AND is_deleted = 0
    </update>

    <delete id="deleteDiaryTags">
        DELETE FROM tb_diary_tag
        WHERE diary_id = #{diaryId}
    </delete>

    <!-- ====================== Tag 관련 ====================== -->

    <select id="selectTagIdByName" parameterType="string" resultType="long">
        SELECT tag_id
        FROM tb_tag
        WHERE tag_name = #{tagName}
    </select>

    <insert id="insertTag" parameterType="string">
        INSERT IGNORE INTO tb_tag (
            tag_name,
            created_at
        )
        VALUES (
            #{tagName},
            NOW()
        )
    </insert>

    <insert id="insertDiaryTag">
        INSERT IGNORE INTO tb_diary_tag (
            diary_id,
            tag_id
        )
        VALUES (
            #{diaryId},
            #{tagId}
        )
    </insert>

    <select id="selectTagNamesByDiaryId" resultType="string">
        SELECT
            t.tag_name
        FROM tb_diary_tag dt
        INNER JOIN tb_tag t ON t.tag_id = dt.tag_id
        WHERE dt.diary_id = #{diaryId}
    </select>

    <select id="selectDiaryTagsByDiaryId" resultType="heyso.HeysoDiaryBackEnd.diary.model.DiaryTag">
        SELECT
            dt.diary_id,
            t.tag_name
        FROM tb_diary_tag dt
        INNER JOIN tb_tag t ON t.tag_id = dt.tag_id
        WHERE dt.diary_id = #{diaryId}
    </select>

    <select id="selectDiaryTags" resultType="heyso.HeysoDiaryBackEnd.diary.model.DiaryTag">
        SELECT
            dt.diary_id,
            t.tag_name
        FROM tb_diary_tag dt
        INNER JOIN tb_tag t ON t.tag_id = dt.tag_id
        WHERE dt.diary_id IN
        <foreach collection="diaryIds" item="id" open="(" separator="," close=")">
            #{id}
        </foreach>
    </select>
</mapper>
